# docker-compose.dev.yml

# -----------------------------------------------------------------------------
# ChordAtlas Development Docker Compose Configuration
# -----------------------------------------------------------------------------
# Purpose:
#   Defines the full development environment for ChordAtlas, supporting
#   live code iteration, hot reloading, and persistent local databases.
#
# Integration with Makefile:
#   This file is referenced by the Makefile as $(DEV_FILE).
#   Common commands include:
#     • make dev        → start the full dev stack in background
#     • make stop       → stop all running dev containers
#     • make rebuild    → rebuild all dev images without cache
#     • make restart    → restart frontend and backend containers
#     • make logs       → follow combined logs of all services
#     • make clean      → remove containers, volumes, and networks
#     • make dbshell    → open MySQL CLI inside db container
#
# Developer Use Cases:
#   - Fresh restart:     make clean && make dev
#   - Rebuild backend:   make backend
#   - Inspect logs:      make logs
#   - Connect to DB:     make dbshell
#
# Summary of stack:
#   • MySQL 8 database for persistent data.
#   • Node-based backend running `npm run dev` (live reload).
#   • Node-based frontend (Vite) on http://localhost:5173.
#   • NGINX proxy serving frontend build and routing /api → backend:5000.
#   • Adminer DB UI on http://localhost:8081.
#
# Environment:
#   Optimized for developer convenience, not security or performance.
# -----------------------------------------------------------------------------

version: "3.9"

services:
  db:
    image: mysql:8.0
    container_name: chordatlas-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: chordatlas
    # ports:
    #   - "3306:3306"
    volumes:
      - db_data:/var/lib/mysql
      - ./backend/db/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-prootpass"]
      interval: 10s
      timeout: 5s
      retries: 10

  backend:
    image: node:20-bullseye-slim
    container_name: chordatlas-backend
    working_dir: /app
    command: sh -c "npm install && npm run dev"
    volumes:
      - ./backend:/app
      - /app/node_modules
    expose:
      - "5000"
    environment:
      NODE_ENV: development
      DB_HOST: db
      DB_PORT: 3306
      DB_USER: root
      DB_PASS: rootpass
      DB_NAME: chordatlas
    depends_on:
      db:
        condition: service_healthy

  frontend:
    image: node:20-bullseye-slim
    container_name: chordatlas-frontend
    working_dir: /app
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    ports:
      - "5173:5173"
    environment:
      - NODE_ENV=development
      - VITE_API_BASE_URL=/api
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
      - VITE_FORCE_POLLING=true
      - VITE_SPOTIFY_CLIENT_ID=fd60447ec28a4a8fa611d8b8769e7ba8
      - VITE_SPOTIFY_REDIRECT_URI=http://127.0.0.1:5173/callback
      - VITE_SPOTIFY_SCOPES=user-read-playback-state user-modify-playback-state streaming user-read-currently-playing
    depends_on:
      - backend

  nginx:
    image: nginx:latest
    container_name: chordatlas-nginx
    restart: unless-stopped
    depends_on:
      - frontend
      - backend
    ports:
      - "8080:80"
    volumes:
      - ./nginx/nginx.dev.conf:/etc/nginx/conf.d/default.conf:ro
      - ./frontend/dist:/usr/share/nginx/html:ro

  adminer:
    image: adminer:latest
    container_name: chordatlas-adminer
    restart: unless-stopped
    ports:
      - "8081:8080"
    environment:
      ADMINER_DEFAULT_SERVER: db
    depends_on:
      - db

volumes:
  db_data:
